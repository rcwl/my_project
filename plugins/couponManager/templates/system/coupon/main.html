<!DOCTYPE html>
<html>
<head>
    <title>券码管理</title>
    {% include 'system/common/header.html' %}
</head>
<body class="pear-container">
    {# 查询表单 #}
    <div class="layui-card">
        <div class="layui-card-body">
            <form class="layui-form" lay-filter="query-form">
                <div class="layui-form-item">
                    <label class="layui-form-label">券码</label>
                    <div class="layui-input-inline">
                        <input type="text" name="code" class="layui-input" placeholder="请输入券码查询">
                    </div>
                    <button class="layui-btn" lay-submit lay-filter="coupon-query">查询</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </form>
        </div>
    </div>

    {# 券码表格 #}
    <div class="layui-card">
        <div class="layui-card-body">
            <table id="coupon-table" lay-filter="coupon-table"></table>
        </div>
    </div>

    {% include 'system/common/footer.html' %}
    <script>
        layui.use(['table', 'form'], function() {
            let table = layui.table;
            let form = layui.form;

            // 渲染表格
            table.render({
                elem: '#coupon-table',
                url: '/system/coupon/data',
                page: true,
                cols: [[
                    {field: 'id', title: 'ID', align: 'center'},
                    {field: 'code', title: '券码', align: 'center'},
                    {field: 'discount', title: '折扣', align: 'center', templet: d => d.discount*10 + '折'},
                    {field: 'description', title: '描述', align: 'center'},
                    {field: 'enable', title: '状态', align: 'center', 
                        templet: d => `<input type="checkbox" name="enable" value="${d.id}" lay-skin="switch" lay-text="启用|禁用" ${d.enable ? 'checked' : ''} lay-filter="coupon-enable">`},
                    {field: 'used', title: '是否使用', align: 'center', templet: d => d.used ? '已使用' : '未使用'},
                    {field: 'create_time', title: '创建时间', align: 'center'},
                    {title: '操作', align: 'center', toolbar: '#table-bar'}
                ]],
                toolbar: '#table-toolbar'
            });

            // 监听查询
            form.on('submit(coupon-query)', function(data) {
                table.reload('coupon-table', {where: data.field});
                return false;
            });

            // 监听启用/禁用
            form.on('switch(coupon-enable)', function(obj) {
                let url = obj.elem.checked ? '/system/coupon/enable' : '/system/coupon/disable';
                layui.$.ajax({
                    url: url,
                    type: 'put',
                    data: JSON.stringify({id: this.value}),
                    contentType: 'application/json',
                    success: res => res.success ? layui.layer.msg('操作成功') : layui.layer.msg('操作失败')
                });
            });
        });
    </script>
</body>
</html>